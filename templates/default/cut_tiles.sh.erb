#!/bin/bash
set -e

# make sure only one is running at any time...
LOCK_FILE="<%= node[:valhalla][:lock_dir] %>/cut_tiles.lock"
(set -C; : > ${LOCK_FILE}) 2> /dev/null
if [ $? != "0" ]; then
   echo "Lock file exists"
   exit 0
fi
trap 'rm $LOCK_FILE' EXIT 1 2 3

export PATH=$PATH:/usr/local/bin
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib

tile_dir=$(jq -r '.mjolnir.hierarchy.tile_dir' <%= node[:valhalla][:config] %>)

#remove the hierarchy dirs.  if we crashed they are left around.
rm -rf ${tile_dir}/0
rm -rf ${tile_dir}/1
rm -rf ${tile_dir}/2

# name the dir where this will go
stamp=$(date +%Y_%m_%d-%H_%M_%S)
cur_tile_dir=$(dirname <%= node[:valhalla][:tile_dir] %>)/tiles_${stamp}

# things we need to make if we dont have them
extracts=$(find <%= node[:valhalla][:extracts_dir] %> -type f -name "*.pbf")
admin_file=$(jq -r '.mjolnir.admin' <%= node[:valhalla][:config] %>)
timezone_file=$(jq -r '.mjolnir.timezone' <%= node[:valhalla][:config] %>)
if [ ! -e $admin_file ]; then
  pbfadminbuilder -c <%= node[:valhalla][:config] %> $(find <%= node[:valhalla][:extracts_dir] %> -type f -name "*.pbf")
fi
if [ ! -e $timezone_file ]; then
  <%= node[:valhalla][:src_dir] %>/mjolnir/scripts/create_tz_db.sh <%= node[:valhalla][:config] %>
fi

#transit data
if [ -f <%= node[:valhalla][:transit_dir] %>.tgz ]; then
  rm -rf <%= node[:valhalla][:transit_dir] %>
  mkdir <%= node[:valhalla][:transit_dir] %>
  tar pxvf <%= node[:valhalla][:transit_dir] %>.tgz -C <%= node[:valhalla][:transit_dir] %>
fi

# cut tiles from the data
pbfgraphbuilder -c <%= node[:valhalla][:config] %> $(find <%= node[:valhalla][:extracts_dir] %> -type f -name "*.pbf")
rm -rf *.bin
set +e

# generate connectivity map geojson, tile dir is as good a place as any
# we can ship the whole tile dir to s3 anyway, admin connectivity and all
pushd <%= node[:valhalla][:tile_dir] %>
connectivitymap -c <%= node[:valhalla][:config] %>
stats_file=$(jq -r '.mjolnir.statistics' <%= node[:valhalla][:config] %>)
mv ${stats_file} $(basename ${stats_file} | sed -e "s/\(\.[^.]\+$\)/_${stamp}\1/g")
stats_file=$(basename ${stats_file} | sed -e "s/\(\.[^.]\+$\)/_${stamp}\1/g")
mv connectivity.geojson connectivity_${stamp}.geojson
popd

# backup files and tile dirs, keep the admin stuff though
mkdir -p ${cur_tile_dir}
mv <%= node[:valhalla][:tile_dir] %>/* ${cur_tile_dir}/
cp -rp ${cur_tile_dir}/$(basename ${admin_file}) <%= node[:valhalla][:tile_dir] %>
cp -rp ${cur_tile_dir}/$(basename ${timezone_file}) <%= node[:valhalla][:tile_dir] %>

# do we want to send this update to s3 (do so in the background)
if [ "<%= node[:valhalla][:with_updates] %>" == true ]; then
  {
    tar pcf - -C ${cur_tile_dir} . | pigz -9 > ${cur_tile_dir}.tgz
    <%= node[:valhalla][:conf_dir] %>/push_tiles.py ${cur_tile_dir}/connectivity_${stamp}.geojson ${cur_tile_dir}/${stats_file} ${cur_tile_dir}.tgz
    rm -rf ${cur_tile_dir} ${cur_tile_dir}.tgz
  }&
fi
